<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Simple Dialer Demo - Phoneburner clone</title>

        <!-- JQUERY -->
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
            integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>

        <!-- FIREBASE -->
        <!--Eventually needs refactoring to v9 SDK-->
        <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase.js"></script>
        <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
        <link
            type="text/css"
            rel="stylesheet"
            href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css"
        />
        <!--bootstrap-->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi"
            crossorigin="anonymous"
        />

        <!-- Bootstrap Font Icon CSS -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.9.1/font/bootstrap-icons.min.css"
            integrity="sha512-5PV92qsds/16vyYIJo3T/As4m2d8b6oWYfoqV+vtizRB6KhF1F9kYzWzQmsO6T3z3QG2Xdhrx7FQ+5R1LiQdUA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />

        <link rel="stylesheet" media="screen" href="css/main.css" />
    </head>
    <body>
        <div class="bg-white col-12" style="width: 700px; margin: auto">
            <div class="p-5 pt-5" id="leftPreview">
                <h3 class="mt-1">Simple dialer</h3>
                <p id="havent-dialed-in">
                    <strong>You haven't dialed in yet.</strong>
                    Call (667) 242-9611 with your phone to start dialing.
                </p>
                <!--<p>The conference ID is: <span class="conference-id">XXXXXXXX</span></p>-->
                <!--<p>Next number to dial is: <span class="next-number"></span></p>-->

                <div class="d-flex" style="width: 400px">
                    <input
                        type="text"
                        class="form-control d-flex me-2 next-number"
                        value="8595359340"
                        disabled
                    />
                    <button
                        id="dial-button"
                        class="btn btn-primary d-flex"
                        onclick="dial($(this).prev().val())"
                        disabled
                    >
                        Dial
                    </button>
                    <button
                        class="btn btn-danger ms-2"
                        onclick="hangup()"
                        disabled
                    >
                        Hangup
                    </button>
                </div>

                <ol class="mt-3">
                    <li class="font-weight-bold">859-535-9340</li>
                    <li>(914) 477-2818</li>
                    <li>Some number you choose (edit above)</li>
                </ol>
                <h3 class="mt-4">Debug Logging</h3>
                <div
                    class="text-bg-dark p-4 mt-3"
                    style="height: 300px; max-width: 600px; overflow: auto"
                >
                    <pre><code>Application logs printed here...</code></pre>
                </div>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
            crossorigin="anonymous"
        ></script>
        <script>
            // Config variable for firebase initialization
            const firebaseConfig = {
                apiKey: "AIzaSyBSG-ctw1FdJ0820-lhkFqv7ezWTKTkClg",
                authDomain: "appealapp.firebaseapp.com",
                databaseURL: "https://appealapp-default-rtdb.firebaseio.com",
                projectId: "appealapp",
                storageBucket: "appealapp.appspot.com",
                messagingSenderId: "430857266789",
                appId: "1:430857266789:web:0e40e176caaf7ec987488c",
            };
            const firebaseApp = firebase.initializeApp(firebaseConfig);

            // Initialize Cloud Functions through Firebase
            var functions = firebase.functions();

            // Init firestore
            const db = firebaseApp.firestore();

            // Numbers to dial
            var numbersToDial = [];
            $("ol li").each((b, a) => numbersToDial.push($(a).text()));
            console.log(numbersToDial);

            function dial(number) {
                // Call the dial functions
                var dialOutAndPlaceInConference = firebase
                    .functions()
                    .httpsCallable("dialOutAndPlaceInConference");
                dialOutAndPlaceInConference({ numberToDial: number }).then(
                    (result) => {
                        // Read result of the Cloud Function.
                        // var sanitizedMessage = result.data.text;
                        console.log(result.data);
                    }
                );
                dialerAdvance();
            }

            function hangup() {
                // Call the dial functions
                var hangupCallableFunction = firebase
                    .functions()
                    .httpsCallable("hangup");
                hangupCallableFunction().then((result) => {
                    // Read result of the Cloud Function.
                    // var sanitizedMessage = result.data.text;
                    console.log(result.data);
                });
            }

            // Store a global variable for updates
            var conferenceUpdates = [];

            // Subscribe to firestore updates
            db.collection("conference-updates")
                .orderBy("Timestamp", "desc")
                .onSnapshot(handleConferenceUpdateSnapshot);

            // Handle the updates
            function handleConferenceUpdateSnapshot(querySnapshot) {
                console.log("handleConferenceUpdateSnapshot()");
                conferenceUpdates = [];
                querySnapshot.forEach((doc) => {
                    conferenceUpdates.push(doc.data());
                });
                //console.log('conferenceUpdates', conferenceUpdates);
                $("code").html("");
                $("code").text(
                    conferenceUpdates
                        .map(
                            (a) =>
                                a.StatusCallbackEvent +
                                " | " +
                                new Date(a.Timestamp)
                        )
                        .join("\n")
                );

                if (
                    (conferenceUpdates[0].StatusCallbackEvent ==
                        "conference-end" ||
                        conferenceUpdates[1].StatusCallbackEvent ==
                            "conference-end") &&
                    conferenceUpdates[0].StatusCallbackEvent !=
                        "participant-join"
                ) {
                    console.log("not dialed in");
                    $('button:contains("Dial")').prop("disabled", true);
                    $('button:contains("Hangup")').prop("disabled", true);

                    $("#havent-dialed-in").show();
                } else {
                    console.log("dialed in!");
                    $('button:contains("Dial")').prop("disabled", false);
                    //$('button:contains("Hangup")').prop('disabled', false); // Hangup needs to be enabled when a call is active
                    $("#havent-dialed-in").hide();
                }

                // Enable hangup button when outbound call is active, disable dial button
                if (
                    conferenceUpdates[0].StatusCallbackEvent ==
                        "participant-join" &&
                    conferenceUpdates[0].ParticipantLabel == "outboundCall"
                ) {
                    //dialerAdvance();
                }

                // Disable hangup button when outbound call ends, enable dial button
                if (
                    conferenceUpdates[0].StatusCallbackEvent ==
                        "participant-leave" &&
                    conferenceUpdates[0].ParticipantLabel == "outboundCall"
                ) {
                    $('button:contains("Hangup")').prop("disabled", true);
                    $('button:contains("Dial")').prop("disabled", false);
                }
            }

            function dialerAdvance() {
                // Change button availability
                $('button:contains("Hangup")').prop("disabled", false);
                $('button:contains("Dial")').prop("disabled", true);

                // Move forward the dialer
                $("li.font-weight-bold + li").addClass("font-weight-bold");
                $("li.font-weight-bold").eq(0).removeClass("font-weight-bold");

                // Change dialer setting
                var nextNumberToCall = $("li.font-weight-bold").text();
                $("input.next-number").val(
                    nextNumberToCall.includes("choose")
                        ? "Write a number to call here"
                        : nextNumberToCall
                );
                if (nextNumberToCall.includes("choose"))
                    $("input.next-number").prop("disabled", false);
                //$('button:contains("Dial")').text('Dial ' + $('li.font-weight-bold').text());
            }
        </script>
    </body>
</html>
